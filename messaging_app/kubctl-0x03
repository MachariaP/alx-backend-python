#!/bin/bash
# kubctl-0x03 - Rolling Update Script

set -e

echo "Starting rolling update to version 2.0..."

# Apply the updated deployment
echo "Applying updated deployment with version 2.0..."
kubectl apply -f blue_deployment.yaml

# Monitor rollout status
echo "Monitoring rollout status..."
kubectl rollout status deployment/django-app-blue --timeout=300s

# Get current pods before update
echo "Pods before update:"
kubectl get pods -l app=django-app

# Set up port forwarding for continuous testing
echo "Setting up port forwarding for continuous testing..."
kubectl port-forward service/django-app-service 8002:8000 &
PORT_FORWARD_PID=$!
sleep 5

# Continuous testing during rollout
echo "Starting continuous testing during rollout..."
SUCCESSFUL_REQUESTS=0
TOTAL_REQUESTS=0

for i in {1..60}; do
    TOTAL_REQUESTS=$((TOTAL_REQUESTS + 1))
    if curl -s -f -o /dev/null -w "Request $i: HTTP %{http_code}\n" http://localhost:8002/health/ --max-time 5; then
        SUCCESSFUL_REQUESTS=$((SUCCESSFUL_REQUESTS + 1))
        echo "✓ Request $i successful"
    else
        echo "✗ Request $i failed or timed out"
    fi
    
    # Check rollout status every 5 requests
    if [ $((i % 5)) -eq 0 ]; then
        echo "--- Rollout status at request $i ---"
        kubectl get pods -l app=django-app
        kubectl rollout status deployment/django-app-blue --watch=false
    fi
    
    sleep 1
done

# Calculate availability
AVAILABILITY=$((SUCCESSFUL_REQUESTS * 100 / TOTAL_REQUESTS))
echo "=========================================="
echo "Rolling update test results:"
echo "Total requests: $TOTAL_REQUESTS"
echo "Successful requests: $SUCCESSFUL_REQUESTS"
echo "Availability: $AVAILABILITY%"
echo "=========================================="

# Clean up port forwarding
kill $PORT_FORWARD_PID 2>/dev/null || true

# Verify rolling update is complete
echo "Verifying rolling update completion..."
kubectl rollout status deployment/django-app-blue

# Get pods after update
echo "Pods after update:"
kubectl get pods -l app=django-app

# Check pod images
echo "Pod images (should show 2.0):"
kubectl get pods -l app=django-app -o jsonpath='{range .items[*]}{.metadata.name}{"\t"}{.spec.containers[*].image}{"\n"}{end}'

echo "Rolling update completed successfully!"
